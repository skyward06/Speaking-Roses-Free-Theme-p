/**
 * Cookie plugin
 *
 * Copyright (c) 2006 Klaus Hartl (stilbuero.de)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 */

 jQuery.cookie = function (b, j, m) {
    if (typeof j != "undefined") {
        m = m || {};
        if (j === null) {
            j = "";
            m.expires = -1;
        }
        var e = "";
        if (m.expires && (typeof m.expires == "number" || m.expires.toUTCString)) {
            var f;
            if (typeof m.expires == "number") {
                f = new Date();
                f.setTime(f.getTime() + m.expires * 24 * 60 * 60 * 1000);
            } else {
                f = m.expires;
            }
            e = "; expires=" + f.toUTCString();
        }
        var l = m.path ? "; path=" + m.path : "";
        var g = m.domain ? "; domain=" + m.domain : "";
        var a = m.secure ? "; secure" : "";
        document.cookie = [b, "=", encodeURIComponent(j), e, l, g, a].join("");
    } else {
        var d = null;
        if (document.cookie && document.cookie != "") {
            var k = document.cookie.split(";");
            for (var h = 0; h < k.length; h++) {
                var c = jQuery.trim(k[h]);
                if (c.substring(0, b.length + 1) == b + "=") {
                    d = decodeURIComponent(c.substring(b.length + 1));
                    break;
                }
            }
        }
        return d;
    }
};

 /**
  * Module to show Recently Viewed Products
  *
  * Copyright (c) 2014 Caroline Schnapp (11heavens.com)
  * Dual licensed under the MIT and GPL licenses:
  * http://www.opensource.org/licenses/mit-license.php
  * http://www.gnu.org/licenses/gpl.html
  *
  */
 
  Shopify.Products = (function () {
    var e = { howManyToShow: 3, howManyToStoreInMemory: 10, wrapperId: "recently-viewed-products", templateId: "recently-viewed-product-template", onComplete: null },
        t = [],
        n = null,
        o = null,
        r = 0,
        i = {
            configuration: { expires: 90, path: "/", domain: window.location.hostname },
            name: "shopify_recently_viewed",
            write: function (e) {
                jQuery.cookie(this.name, e.join(" "), this.configuration);
            },
            read: function () {
                var e = [],
                    t = jQuery.cookie(this.name);
                return null !== t && (e = t.split(" ")), e;
            },
            destroy: function () {
                jQuery.cookie(this.name, null, this.configuration);
            },
            remove: function (e) {
                var t = this.read(),
                    n = jQuery.inArray(e, t);
                -1 !== n && (t.splice(n, 1), this.write(t));
            },
        },
        a = function () {
            t.length && r < e.howManyToShow
                ? jQuery.ajax({
                      dataType: "json",
                      url: "/products/" + t[0] + ".js",
                      cache: !1,
                      success: function (e) {
                          e.selectedVariant = e.variants.find(function(item){
                            return item.available;
                          }) || e.variants[0];
                          e.compare_at_price = e.selectedVariant.compare_at_price;
                          e.price = e.selectedVariant.price;
                          if (e.available || VastaShop.Variables.enabled_out_of_stock) {
                              var i = window.product_without_image || null;
                              (e.featured_image = e.featured_image || i), o.tmpl(e).appendTo(n);
                          }
                          t.shift(), r++, a();
                      },
                      error: function () {
                          i.remove(t[0]), t.shift(), a();
                      },
                  })
                : (function () {
                      if ((n.show(), e.onComplete))
                          try {
                              e.onComplete();
                          } catch (e) {}
                  })();
        };
    return {
        resizeImage: function (e, t) {
            if (null == t) return e;
            if ("master" == t) return e.replace(/http(s)?:/, "");
            var n = e.match(/\.(jpg|jpeg|gif|png|bmp|bitmap|tiff|tif)(\?v=\d+)?/i);
            if (null != n) {
                var o = e.split(n[0]),
                    r = n[0];
                return (o[0] + "_" + t + r).replace(/http(s)?:/, "");
            }
            return null;
        },
        showRecentlyViewed: function (r) {
            (r = r || {}), jQuery.extend(e, r), (t = i.read()), (o = jQuery("#" + e.templateId)), (n = jQuery("#" + e.wrapperId)), (e.howManyToShow = Math.min(t.length, e.howManyToShow)), e.howManyToShow && o.length && n.length && a();
        },
        getConfig: function () {
            return e;
        },
        clearList: function () {
            i.destroy();
        },
        recordRecentlyViewed: function (t) {
            (t = t || {}), jQuery.extend(e, t);
            var n = i.read();
            if (-1 !== window.location.pathname.indexOf("/products/")) {
                var o = window.location.pathname.match(/\/products\/([a-z0-9\-]+)/)[1],
                    r = jQuery.inArray(o, n);
                -1 === r ? (n.unshift(o), (n = n.splice(0, e.howManyToStoreInMemory))) : (n.splice(r, 1), n.unshift(o)), i.write(n);
            }
        },
    };
})();
