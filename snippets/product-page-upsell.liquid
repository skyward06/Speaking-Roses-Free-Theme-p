<!-- start product-page-upsell - -->

<style>
  .product-page__upsell-wrapper {
    clear: both;
    float: left;
    width: 100%;
  }

  .product-page__upsell {
    width: 100%;
    margin-top: 8px;
  }

  .product-page__upsell-title {
    margin: 34px 0 2px;
    text-align: center;
    font-size: 24px;
    line-height: 1;
    font-weight: 700;
    clear: both;
  }

  .product-page__upsell-list-items {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .product-page__upsell-list-items > .product-page__upsell-product:nth-child(n + 3) {
    display: none;
  }

  .product-page__upsell-list-items .slick-arrow {
    width: 20px;
    height: 20px;
    z-index: 2;
  }

  .product-page__upsell-list-items .slick-arrow::before {
    content: '';
    width: 20px;
    height: 20px;
    display: inline-block;
    background-size: 60%;
    background-repeat: no-repeat;
    position: relative;
  }

  .product-page__upsell-list-items .prev-arrow::before {
    background-image: url("{{ 'left-arrow.svg' | asset_url }}");
    background-position: left;
    left: 2px;
  }

  .product-page__upsell-list-items .next-arrow::before {
    background-image: url("{{ 'right-arrow.svg' | asset_url }}");
    background-position: right;
    right: 2px;
  }

  .product-page__upsell-list-items .slick-slide {
    margin-left: 14px;
  }

  .product-page__upsell-list-items .slick-track {
    margin-left: -8px;
  }

  .product-page__upsell-list-items .slick-list {
    width: 100%;
    padding: 5px 0;
  }

  .product-page__upsell-product {
    padding: 12px 10px;
    border-radius: 8px;
    box-shadow: 0px 0px 4px 0px #0000002b;
    width: 50%;
  }

  .product-page__upsell-product-content {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-page__upsell-product-image-wrapper {
    width: 80px;
    margin-right: 5px;
    height: 100%;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: 4px;
  }

  .product-page__upsell-product-image-link {
    display: block;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .product-page__upsell-product-image-link svg,
  .product-page__upsell-product-image {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }

  .product-page__upsell-product-info {
    padding-left: 13px;
    border-left: solid 1px #E5E5E5;
    display: flex;
    flex-direction: column;
  }

  .product-page__upsell-product-title-price-wrapper {
    display: flex;
    align-items: flex-start;
    flex-direction: column;
    gap: 2px;
  }

  .product-page .rte .product-page__upsell-product-title {
    margin-bottom: 0;
  }

  .product-page .rte .product-page__upsell-product-title--link {
    color: #252525;
    font-size: 14px;
    line-height: 1;
    font-weight: 500;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    line-clamp: 1;
    -webkit-box-orient: vertical;
    letter-spacing: 0;
  }
  .product-page__upsell-product-price {
    text-align: end;
    font-size: 14px;
    font-weight: 600;
    color: #000;
  }

  .product-page__upsell-atc-form {
    display: flex;
    align-items: flex-start;
    flex-direction: column;
    margin-top: 3px;
  }

  .product-page__upsell-select-wrapper {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .product-page__upsell-product-select {
    width: 95px;
    height: 21.64px;
    border: 1px solid #ededed;
    font-size: 12px;
    font-weight: 500;
    color: #757575;
    padding: 0 4px 4px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background: url('{{ "vector.svg" | asset_url  }}') no-repeat 95.7% 35.8%;
  }
  .product-page__upsell-product-select::after {
    content: "";
  }

  .product-page__upsell-product-select:focus {
    border: 1px solid #000;
    outline: none; 
  }

  .product-page__upsell-atc-price-wrapper {
    position: relative;
    width: 100%;
  }

  .product-page__upsell-atc-price {
    width: 100%;
    height: 33.935px;
    max-width: 100%;
    font-size: 14px;
    padding: 0 1px 0 0;
    margin-top: 4.7px;
    color: #000;
    background: transparent;
    border: 1px solid #000;
    border-radius: 5px;
  }

  .product-page__upsell-atc-price[disabled] {
    background-color: #eee;
    color: #bbb;
    border: 1px solid #bbb;
  }

  .product-page__upsell-atc--mask {
    display: none;
    visibility: hidden;
    position: absolute;
    opacity: 0;
    width: 100%;
    left: 0;
    cursor: pointer;
    height: 100%;
  }

  .product-page__upsell-atc-price[disabled='disabled'] + .product-page__upsell-atc--mask {
    display: block;
    visibility: visible;
    opacity: 1;
  }

  @media (max-width: 1019px) {
    .product-page__upsell {
      margin: 10px auto;
      position: relative;
    }

    .product-page__upsell-title {
      font-size: 20px;
      margin: 28px 0 2px;
    }

    .product-page__upsell-subtitle {
      font-size: 14px;
    }

    .product-page__upsell-product {
      padding: 16px 18px 15px;
      border-radius: 15px;
    }

    .product-page__upsell-list-items .slick-arrow::before,
    .product-page__upsell-list-items .slick-arrow {
      width: 15px;
    }

    .product-page__upsell-list-items .prev-arrow::before {
      position: absolute;
      left: 3px;
      top: 45%;
      transform: scale(1.5);
    }

    .product-page__upsell-list-items .next-arrow::before {
      position: absolute;
      right: 3px;
      top: 45%;
      transform: scale(1.5);
    }

    .product-page__upsell-list-items .slick-slide {
      margin-left: 18px;
    }

    .product-page__upsell-product-info {
      margin-left: 19px;
      padding-left: 16px;
    }

    .product-page__upsell-product-title-price-wrapper {
      gap: 8px;
    }

    .product-page__upsell-price {
      font-size: 18px;
      letter-spacing: 0.2px;
    }

    .product-page__upsell-atc-wrapper .product-page__upsell-atc-form {
      margin-top: 8px;
    }

    .product-page .rte .product-page__upsell-product-title--link {
      font-size: 18px;
      letter-spacing: 0;
    }

    .product-page__upsell-product-price {
      font-size: 18px;
      line-height: 1;
    }

    .product-page__upsell-product-image-wrapper {
      width: 35%;
      height: 100%;
    }

    .product-page__upsell-product-select {
      width: 122px;
      height: 28px;
      padding: 3px 4.5px;
      font-size: 15px;
      letter-spacing: 0.4px;
      background: url('{{ "vector.svg" | asset_url  }}') no-repeat 95.7% 52.4%;
    }

    .product-page__upsell-atc-price {
      width: 180px;
      height: 43px;
      font-size: 16px;
      border-radius: 6px;
      margin-top: 8px;
    }
  }

  @media (max-width: 767px) {
    .product-page__upsell-title {
      font-size: 16px;
      margin: 20px 0 0px;
    }

    .product-page__upsell-subtitle {
      font-size: 12px;
      text-align: center;
      margin-bottom: 10px;
    }

    .product-page__upsell-product {
      padding: 12px 13px 10px;
      border-radius: 10px;
    }

    .product-page__upsell {
      margin: 17px auto 18px;
    }
    
    .product-page__upsell-list-items .slick-arrow::before {
      top: 45%;
      transform: scale(1.3);
    }    

    .product-page__upsell-list-items .slick-slide {
      margin-left: 10px;
    }
  
    .product-page__upsell-list-items .slick-track {
      margin-left: -6px;
    }

    .product-page__upsell-list-items .slick-list {
      width: 72%;
    }

    .product-page__upsell-product-title-price-wrapper {
      margin-top: 0;
    }

    .product-page .rte .product-page__upsell-product-title--link {
      font-size: 12.461px;
    }

    .product-page__upsell-product-image-wrapper {
      width: 90px;
      height: 90px;
    }

    .product-page__upsell-product-info {
      margin-left: 12px;
      padding-left: 11px;
      gap: 0px;
    }

    .product-page__upsell-product-title-price-wrapper {
      gap: 6px;
    }

    .product-page__upsell-price {
      font-size: 12px;
    }

    .product-page__upsell-atc-wrapper .product-page__upsell-atc-form {
      margin-top: 4px;
      gap: 0px;
    }

    .product-page__upsell-atc-price-wrapper {
      margin-top: 0;
    }

    .product-page__upsell-product-select {
      width: 86px;
      height: 19.589px;
      font-size: 10px;
    }

    .product-page__upsell-atc-form {
      gap: 7px;
    }

    .product-page__upsell-product-price {
      font-size: 12px;
    }

    .product-page__upsell-atc-price {
      font-size: 12px;
      width: 126.459px;
      height: 30.264px;
      margin-top: 6px;
    }
  }
</style>

{% assign upsell_collection = settings.upsell_collection %}
{% assign upsell_products = collections[upsell_collection].products | where: 'available' %}
{% assign limit_products = settings.products_cart_drawer_upsell | default: 2 %} 

<div id="upsell-product-page" class="product-page__upsell">

  {% if settings.upsell_title != blank %}
    <h3 class="product-page__upsell-title upsell-title">{{ settings.upsell_title }}</h3>
  {% endif %}

  {% if settings.upsell_subtitle != blank %}
    <p class="product-page__upsell-subtitle upsell-subtitle">{{ settings.upsell_subtitle }}</p>
  {% endif %}

  <div class="product-page__upsell-list-items">
    {% for product in upsell_products %}
      <div class="product-page__upsell-product" data-product-id="{{ product.id }}">
        <div class="product-page__upsell-product-wrapper">
          <div class="product-page__upsell-product-content">
            <div class="product-page__upsell-product-image-wrapper">
              <a class="product-page__upsell-product-image-link" href="{{ product.url | default: '#' }}">
                {% assign image_alt = 'Upsell Product Image-' | append: forloop.index %}
                {%
                  render 'responsive-image' with
                  image: product.featured_image,
                  width: 100,
                  height: 100,
                  lazyload: true,
                  class: 'product-page__upsell-product-image'
                  alt: image_alt
                %}
              </a>
            </div>

            <div class="product-page__upsell-product-info">
              <div class="product-page__upsell-product-title-price-wrapper">
                <div class="product-page__upsell-product-title-wrapper">
                  <h2 class="product-page__upsell-product-title">
                    <a class="product-page__upsell-product-title--link" href="{{ product.url | default: '#' }}">
                      {{ product.title }}
                    </a>
                  </h2>
                </div>

                <div class="product-page__upsell-product-price-wrapper">
                  <div class="product-page__upsell-product-price">
                    <span class="product-page__upsell-price">{{ product.price | money }}</span>
                  </div>
                </div>
              </div>

              <div class="product-page__upsell-atc-wrapper">
                  <form action="/cart/add" class="product-page__upsell-atc-form">
                  <div class="product-page__upsell-select-wrapper">
                    {% assign variants_options = product.options_with_values %}
    
                    {% assign values = '' %}
                    {% for variant in product.variants %}
                      {% if variant.available %}
                        {% unless values contains variant.option1 %}
                          {% assign values = values | join: ',' %}
                          {% assign values = values | append: ',' | append: variant.option1 %}
                          {% assign values = values | split: ',' %}
                        {% endunless %}
                      {% endif %}
                    {% endfor %}
    
                    {% for option in variants_options %}
                      <select class="product-page__upsell-product-select" data-index="{{ forloop.index }}">
                        <option value="" selected disabled>{{ option.name }}:</option>
    
                        {% if forloop.first %}
                          {% for value in values %}
                            {% if value == blank %}{% continue %}{% endif %}
                            <option value="{{ value }}">{{ value }}</option>
                          {% endfor %}
                        {% endif %}
                      </select>
                    {% endfor %}
    
                    <select
                      id="upsell-all-product-variants"
                      name="items[{{- forloop.index0 -}}][id]"
                      class="product-page__upsell-all-product-variants hide"
                      data-productid="{{ product.id }}"
                    >
                      {% for variant in product.variants %}
                        {% if variant.available %}
                          <option value="{{ variant.id }}">{{- variant.title -}}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                  </div>
    
                  <input type="hidden" name="items[{{- forloop.index0 -}}][quantity]" value="1">
    
                  <div class="product-page__upsell-atc-price-wrapper">
                    <button
                      id="upsell-atc-{{ product.id }}"
                      class="product-page__upsell-atc-price btn"
                      disabled
                      data-variant="{{ product.selected_or_first_available_variant.id }}"
                    >
                      {{ settings.upsell_atc_btn_text }}
                    </button>
                    <span class="product-page__upsell-atc--mask"></span>
                  </div>
                  </form>
              </div> 
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>



<script>
   window.addEventListener('load',function () {
    $('.product-page__upsell-list-items').slick({
      prevArrow: '<button type="button" class="prev-arrow"></button>',
      nextArrow: '<button type="button" class="next-arrow"></button>',
      infinite: true,
      slidesToShow: 2,
      slidesToScroll: 1,
      responsive: [
        {
          breakpoint: 600,
          settings: {
            slidesToShow: 1
          }
        }
      ]
    });

    $.getJSON('/collections/{{- upsell_collection -}}/products.json', function (allProducts) {
      window.ALLPRODUCTS = allProducts;

      $(document).on('change', '.product-page__upsell-product-select', function () {
        try {
          const $input = $(this);
          const selectedValue = $input.val();
          const $lineItem = $input.closest('.product-page__upsell-product');
          const index = parseInt($input.attr('data-index') || 1);
          const nextOptionIndex = index + 1;
          const productID = $lineItem.attr('data-product-id');
          const product = window.ALLPRODUCTS.products.find(function (p) {
          
          return p.id == productID;
          });

          if (!product) {
            throw new Error('Product does not exist.');
          }

          if (nextOptionIndex > product.options.length) {
            /* Set the variant */
            let variant = product.variants;

            $('.product-page__upsell-product-select', $lineItem).each(function (i) {
              const value = $(this).val();

              variant = variant.filter(function (v) {
                return value == v['option' + (i + 1)];
              });
            });

            if (variant.length > 0) {
              variant = variant[0];

              $('.product-page__upsell-all-product-variants', $lineItem)
                .prop('disabled', false)
                .val(variant.id)
                .trigger('change');
              $('.product-page__upsell-atc-price', $lineItem).prop('disabled', false);
            }
          } else {
            $('.product-page__upsell-atc-price', $lineItem).prop('disabled', true);

            /* Filter the variants based in the selected option */
            let variants = product.variants.filter(function (variant) {
              return variant.available && variant['option' + index] == selectedValue;
            });

            /* Adjust the variants for the next option */
            $input.nextAll('.product-page__upsell-product-select').each(function () {
              const options = $(this).find('option').not('[disabled]');

              $(options).remove();
            });

            const optionsValues = [];

            variants.forEach(function (variant) {
              if (!optionsValues.includes(variant['option' + nextOptionIndex])) {
                optionsValues.push(variant['option' + nextOptionIndex]);
              }
            });

            const $nextInput = $input.next('.product-page__upsell-product-select');
            const $firstOption = $nextInput.find('option').first();

            optionsValues.forEach(function (value) {
              const newOption = document.createElement('option');

              newOption.setAttribute('value', value);
              newOption.innerHTML = value;

              $nextInput.append(newOption);
            });

            $nextInput.val($firstOption.val());
          }
        } catch (err) {
          console.error(err);
        }
      });
    });
  }); 
</script>
